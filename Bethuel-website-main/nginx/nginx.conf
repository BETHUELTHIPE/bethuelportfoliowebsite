# Define an upstream for the Django application (Gunicorn)
# This makes the configuration cleaner and allows for easy load balancing in the future.
upstream django_server {
    # The name 'web' comes from your docker-compose service name.
    # Port 8000 is the port Gunicorn is running on inside the 'web' container.
    server web:8000;
}

# Main server block for handling HTTPS traffic
server {
    listen 80; # Listen for incoming HTTP requests
    # Replace 'your_domain.com' with your actual domain name.
    server_name localhost your_domain.com www.your_domain.com;

    # Redirect all HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    # Set a max size for file uploads (e.g., 50MB). Adjust as needed.
    client_max_body_size 2000M;

    # --- Location Blocks ---
    # Location for serving static files directly by Nginx
    location /static/ {
        # The alias path corresponds to the 'static_volume' in docker-compose
        alias /app/staticfiles/;
        # Add aggressive caching for static assets
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
    }

    # Location for serving user-uploaded media files
    location /media/ {
        # The alias path corresponds to the 'media_volume' in docker-compose
        alias /app/mediafiles/;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
    }

    # Location for proxying all other requests to the Django application
    location / {
        proxy_pass http://django_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Increase timeouts for long-running requests (e.g., file uploads, long queries)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # SSL/TLS Configuration
    # Listen on port 443 for HTTPS traffic
    listen 443 ssl;
    server_name localhost your_domain.com www.your_domain.com;

    # Replace with the actual path to your SSL certificate and key
    # These paths will depend on how you mount them in your Docker container.
    # ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;
}